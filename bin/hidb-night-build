#! /bin/bash

export ACMACSD_ROOT=$HOME/AD
PROG=$(readlink -f $0)
LOG=/syn/eu/log/hidb4-night-build.log
DB_DIR=$ACMACSD_ROOT/data

export PATH="$ACMACSD_ROOT/bin:$HOME/bin:/usr/local/bin:$PATH"
export TIME='<Time %E>'

if [ "$(uname)" == "Linux" ]; then
    export LD_LIBRARY_PATH="$ACMACSD_ROOT/lib"
fi

on_error()
{
    (echo $PROG FAILED; echo "LOG: $LOG") | mail -s "$(hostname) $PROG FAILED" eu@antigenic-cartography.org
    exit 1
}

trap on_error ERR

exec > "$LOG"
exec 2>&1

date
echo Updating acmacs-c2
cd ~/ac/acmacs
git pull
c2 make -j11 acmacs

echo "=================================================================="
date
echo Updating ACMACSD packages
/usr/bin/time update-all

echo
echo "=================================================================="
date
echo H3
echo
DB=$DB_DIR/hidb4.h3.json.xz
if [ -f "$DB" ]; then mv -f "$DB" "$DB"~; fi
/usr/bin/time hidb-update --db "$DB" ~/ac/tables-store/H3/{CDC,MELB,NIID,NIMR}/*.ac* 2>&1

echo
echo "=================================================================="
date
echo H1PDM
echo
DB=$DB_DIR/hidb4.h1.json.xz
if [ -f "$DB" ]; then mv -f "$DB" "$DB"~; fi
/usr/bin/time hidb-update --db "$DB" ~/ac/tables-store/H1PDM/{CDC,MELB,NIID,NIMR}/*.ac* 2>&1

echo
echo "=================================================================="
date
echo B
echo
DB=$DB_DIR/hidb4.b.json.xz
if [ -f "$DB" ]; then mv -f "$DB" "$DB"~; fi
/usr/bin/time hidb-update --db "$DB" ~/ac/tables-store/B/{CDC,NIID,NIMR}/*.ac* ~/ac/tables-store/B/MELB/{yamagata,victoria}/*.ac* 2>&1
echo
date
echo "----------------------------------------------------------------------"

(echo "$PROG completed"; echo "LOG: $LOG") | mail -s "$(hostname) $PROG completed" eu@antigenic-cartography.org
